{% extends 'phyto_backend/base.html' %}

{% load static %}
{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'phyto_backend/segmentation.css' %}">
<form class="form" method="post" enctype="multipart/form-data" id="myForm">
  {% csrf_token %}
  <div class="file-upload">
    <button class="file-upload-btn" type="button" onclick="$('.file-upload-input').trigger( 'click' )">ВЫБРАТЬ НОВОЕ ИЗОБРАЖЕНИЕ</button>

    <div class="image-upload-wrap">
      <input name="image" class="file-upload-input" type='file' onchange="readURL(this);" accept="image/*" />
      <div class="drag-text">
        <h3>Перетащите файл или нажмите на кнопку "Выбрать новое изображение"</h3>
      </div>
    </div>
    <div class="file-upload-content">
      <img class="file-upload-image" src="#" />
      <div class="image-title-wrap">
        <button type="button" onclick="removeUpload()" class="remove-image">Удалить</button> <button type="submit" class="file-send-btn">Сегментировать</button>
      </div>
    </div>
    <div class="segment-result" id="result"></div>
    <br>
    <div class="segment-result" id="send-email-div" style="display: none;">
      <input type="text" placeholder="Введите e-mail">
      <button class="email-send-btn">Отправить</button>
    </div>
  </div>
</form>
<script>
  function readURL(input) {
  if (input.files && input.files[0]) {

    var reader = new FileReader();

    reader.onload = function(e) {
      $('.image-upload-wrap').hide();
      $('.send-email-div').hide();
      $('.file-upload-image').attr('src', e.target.result);
      $('.file-upload-content').show();

      $('.image-title').html(input.files[0].name);
    };

    reader.readAsDataURL(input.files[0]);

  } else {
    removeUpload();
  }
}

function removeUpload() {
  $('.file-upload-input').replaceWith($('.file-upload-input').clone());
  $('.file-upload-content').hide();
  $('.image-upload-wrap').show();
  $('.send-email-div').hide();
  const myNode = document.getElementById("result");
  myNode.innerHTML = '';
}
$('.image-upload-wrap').bind('dragover', function () {
    $('.image-upload-wrap').addClass('image-dropping');
  });
  $('.image-upload-wrap').bind('dragleave', function () {
    $('.image-upload-wrap').removeClass('image-dropping');
});

$('#myForm')
    .ajaxForm({
        type: "POST",
        url : "{% url 'phyto_backend:segment' %}",
        dataType : "json",
        success : function (response) {
            const myNode = document.getElementById("result");
            myNode.innerHTML = '';

            var img = new Image();
            var MAX_WIDTH = 600;
            var MAX_HEIGHT = 800;
            img.onload = function(){
              var width = img.width;
              var height = img.height;

              // Change the resizing logic
              if (width > height) {
                  if (width > MAX_WIDTH) {
                      height = height * (MAX_WIDTH / width);
                      width = MAX_WIDTH;
                  }
              } else {
                  if (height > MAX_HEIGHT) {
                      width = width * (MAX_HEIGHT / height);
                      height = MAX_HEIGHT;
                  }
              }
              img.width = width;
              img.height = height;
              document.getElementById("result").appendChild(img);
            };
            img.src = 'data:image/gif;base64,' + response['image-result'];
            img.className = "image-segment-result";
            document.getElementById("send-email-div").style = "";
        }
    })
;

</script>
{% endblock %}